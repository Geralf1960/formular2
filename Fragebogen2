<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Fragebogen mit Excel-Upload</title>
  <style>
    body { font-family: Arial; max-width: 700px; margin: 30px; }
    #frage-container, #upload-section, #abschluss { margin-top: 30px; }
    button { padding: 10px 20px; margin-top: 10px; }
    #upload-section { background: #eef; padding: 15px; border-left: 4px solid #4CAF50; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

<h2>Fragebogen – Schritt für Schritt mit Excel Upload</h2>

<!-- Excel-Datei hochladen -->
<label>1. Lade die Excel-Datei mit den Upload-Links hoch:</label><br>
<input type="file" id="excelInput" accept=".xlsx" />
<div id="excel-status" style="margin-top:10px;"></div>

<!-- Fragebogen -->
<div id="user-info"></div>
<div id="frage-container" style="display:none;"></div>
<div id="upload-section" style="display:none;"></div>
<div id="abschluss" style="display:none;">
  <h3>Vielen Dank! Der Fragebogen ist abgeschlossen.</h3>
</div>

<script>
let uploadLinks = {}; // wird aus Excel geladen
let fragen = [
  "1. Benötigen Sie technische Unterlagen?",
  "2. Möchten Sie Bildmaterial hochladen?",
  "3. Wollen Sie ein Formular zur Freigabe senden?",
  "4. Müssen Sie ein Vertragsexemplar hochladen?",
  "5. Haben Sie ergänzende Unterlagen?",
  "6. Wollen Sie interne Notizen bereitstellen?",
  "7. Möchten Sie Videoaufnahmen hochladen?",
  "8. Benötigen Sie eine Upload-Möglichkeit für Präsentationen?",
  "9. Möchten Sie Planungsdokumente übermitteln?",
  "10. Müssen Sie eine Projektbeschreibung hochladen?"
];
let user = null;
let currentIndex = 0;

const excelInput = document.getElementById("excelInput");
const excelStatus = document.getElementById("excel-status");
const userInfo = document.getElementById("user-info");
const frageContainer = document.getElementById("frage-container");
const uploadSection = document.getElementById("upload-section");
const abschluss = document.getElementById("abschluss");

// Excel-Datei laden
excelInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (evt) => {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    // Excel muss Spalten "Benutzername" und "UploadLink" haben
    rows.forEach(row => {
      if (row.Benutzername && row.UploadLink) {
        uploadLinks[row.Benutzername.toLowerCase()] = row.UploadLink;
      }
    });

    excelStatus.innerHTML = `<p style="color:green;">${rows.length} Benutzer geladen.</p>`;

    // Fragebogen starten
    initialisiereFragebogen();
  };
  reader.readAsArrayBuffer(file);
});

function initialisiereFragebogen() {
  const params = new URLSearchParams(window.location.search);
  user = params.get("user")?.toLowerCase();

  if (!user || !uploadLinks[user]) {
    userInfo.innerHTML = `<p style="color:red;">Ungültiger oder fehlender Benutzer. Rufe die Seite mit <code>?user=max</code> auf.</p>`;
    return;
  }

  userInfo.innerHTML = `<p>Hallo <strong>${user}</strong>, bitte beantworte die folgenden Fragen einzeln.</p>`;
  frageContainer.style.display = "block";
  zeigeFrage();
}

function zeigeFrage() {
  if (currentIndex >= fragen.length) {
    frageContainer.style.display = "none";
    uploadSection.style.display = "none";
    abschluss.style.display = "block";
    return;
  }

  const frage = fragen[currentIndex];
  frageContainer.innerHTML = `
    <p>${frage}</p>
    <button onclick="antwort('ja')">Ja</button>
    <button onclick="antwort('nein')">Nein</button>
  `;
  uploadSection.style.display = "none";
}

function antwort(wert) {
  if (wert === "ja") {
    const link = uploadLinks[user];
    uploadSection.innerHTML = `
      <p>Bitte laden Sie Ihre Datei hoch:</p>
      <a href="${link}" target="_blank">${link}</a><br><br>
      <button onclick="naechsteFrage()">Fertig hochgeladen</button>
    `;
    uploadSection.style.display = "block";
    frageContainer.style.display = "none";
  } else {
    currentIndex++;
    zeigeFrage();
  }
}

function naechsteFrage() {
  currentIndex++;
  frageContainer.style.display = "block";
  zeigeFrage();
}
</script>

</body>
</html>
